<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<style>
	body {
	  font: 12px sans-serif;
	}
</style>
</head>
<body>
<script src="lib/d3.min.js"></script>
<script src="lib/jquery/jquery-1.8.3.min.js"></script>
<script src="lib/d3.v3.js"></script>
<script src="lib/tooltip.js"></script>
<script>
function replaceAll(find, replace, str) {
  return str.replace(new RegExp(find, 'g'), replace);
}

function shortenValueFilter(str) {
  //convert to string
  str = String(str);
  if (str.indexOf('"') == 0) {
	var shortStr = str.substring(1, str.length);
	var returnStr = shortStr.substring(0, shortStr.indexOf('"'));
	return returnStr;
  } else if (str.indexOf('http://') !== -1) {
	var myRe = new RegExp("([^/]*)$");
	var returnStr = myRe.exec(str);
	return returnStr[0];
  } else {
	return str;
  }
}

//var dataString = {"type":"pie","dataSeries":[[{"pieVal":55,"pieCat":"Flags_of_Our_Fathers"},{"pieVal":55,"pieCat":"Letters_from_Iwo_Jima"},{"pieVal":55,"pieCat":"Midnight_in_the_Garden_of_Good_and_Evil"},{"pieVal":55,"pieCat":"Million_Dollar_Baby"},{"pieVal":55,"pieCat":"Mystic_River"},{"pieVal":55,"pieCat":"Space_Cowboys"}]],"names":["Title","Revenue"]};

var width = 960,
    height = 500,
    radius = Math.min(width, height) / 2;
	
var margin = {top: 20, right: 20, bottom: 80, left: 20},
        container = {width: 0, height: 0},
		color;
          
var color = d3.scale.category20();

var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(0);

var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) { 
		return d.pieVal; 
	});

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
	.append("g")
    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
	
//start(dataString);	
function start(dataString) {
	var dataStringJson = jQuery.parseJSON(dataString);
	var jsonData = dataStringJson.dataSeries;
	var data = [];	
	data = jsonData[0];
			
	data.forEach(function(d) {
		d.pieVal = Number(+d.pieVal);
	});
			
	var g = svg.selectAll(".arc")
	  .data(pie(data))
	  .enter().append("g")
	  .attr("class", "background")
	  .attr("class", "arc");	  
	  
	g.append("path")
	  .attr("d", arc)
	  .style("fill", function(d) { 
		return color(d.data.pieCat); 
	});

	g.append("text")
	  .attr("class", "foreground")
	  .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
	  .attr("dy", ".35em")
	  .style("text-anchor", "middle")
	  .text(function(d) { 
		var retVal = shortenValueFilter(d.data.pieCat)
		retVal = replaceAll('_', ' ', retVal)
		return retVal; 
	  });
	  

}
</script>
</body>
</html>