<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
<style>
	body {
	  font: 12px sans-serif;
	}
	.d3-tip {
		line-height: 1.4;
		font-weight: bold;
		padding: 12px;
		background: rgba(0, 0, 0, 0.8);
		color: #fff;
		border-radius: 3px;
		margin-top: -7px;
		font-family: sans-serif;
		font-size: 12px;
	}
	/* Creates a small triangle extender for the tooltip */
	.d3-tip:after {
		box-sizing: border-box;
		display: inline;
		font-size: 10px;
		width: 100%;
		line-height: 1;
		color: rgba(0, 0, 0, 0.8);
		content: "\25BC";
		position: absolute;
		text-align: center;
	}
	/* Style northward tooltips differently */
	.d3-tip.n:after {
		margin: -1px 0 0 0;
		top: 98%;
		left: 0;
	}
</style>
</head>
<body>
<script src="lib/d3.min.js"></script>
<script src="lib/jquery/jquery-1.8.3.min.js"></script>
<script src="lib/d3.v3.js"></script>
<script src="lib/tooltip.js"></script>
<script>
function replaceAll(find, replace, str) {
  return str.replace(new RegExp(find, 'g'), replace);
}

function shortenValueFilter(str) {
  //convert to string
  str = String(str);
  if (str.indexOf('"') == 0) {
	var shortStr = str.substring(1, str.length);
	var returnStr = shortStr.substring(0, shortStr.indexOf('"'));
	return returnStr;
  } else if (str.indexOf('http://') !== -1) {
	var myRe = new RegExp("([^/]*)$");
	var returnStr = myRe.exec(str);
	return returnStr[0];
  } else {
	return str;
  }
}

//var dataString = {"type":"pie","dataSeries":[[{"pieVal":55,"pieCat":"Flags_of_Our_Fathers"},{"pieVal":55,"pieCat":"Letters_from_Iwo_Jima"},{"pieVal":55,"pieCat":"Midnight_in_the_Garden_of_Good_and_Evil"},{"pieVal":55,"pieCat":"Million_Dollar_Baby"},{"pieVal":55,"pieCat":"Mystic_River"},{"pieVal":55,"pieCat":"Space_Cowboys"}]],"names":["Title","Revenue"]};

var width = 960,
    height = 500,
    radius = Math.min(width, height) / 2;
	
var margin = {top: 20, right: 20, bottom: 80, left: 20},
        container = {width: 0, height: 0},
		color;
          
var color = d3.scale.category20();

var arc = d3.svg.arc()
    .outerRadius(radius - 10)
    .innerRadius(0);

var pie = d3.layout.pie()
    .value(function(d) { return d.pieVal; });

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
	.append("g")
    .attr("transform", "translate(" + width / 1.8 + "," + height / 2 + ")");	
	
/* Initialize tooltip */
var tip = d3.tip()
	.attr('class', 'd3-tip')
	.style("z-index", "10000")
  //.offset([47, 0])
	.html(function (d) {
		return "<div> <span class='light'>" + d.data.pieCat + ":</span> " + d.data.pieVal + "</div>";
	});

tip.offset([100,0]); //TODO: calculate offset w/ angles or tie to cursor position
svg.call(tip); /* Invoke the tooltip in the context of your visualization */

//start(dataString);	
function start(dataString) {
	var dataStringJson = jQuery.parseJSON(dataString);
	var jsonData = dataStringJson.dataSeries;
	var data = [];	
	data = jsonData[0];
			
	data.forEach(function(d) { d.pieVal = Number(+d.pieVal); });
			
	var g = svg.selectAll(".arc")
	  .data(pie(data))
	  .enter().append("g")
	  .attr("class", "background")
	  .attr("class", "arc");	
	 
	var count = 0;
	g.append("path")
	  .attr("d", arc)
	  .attr("id", function(d) { return "arc-" + (count++); })
	  .style("fill", function(d) { return color(d.data.pieCat); })
	  .on('mouseover', function (d) { tip.show(d); })
	  .on('mouseout', function (d) { tip.hide(d); });
	  

	g.append("text")
	  .attr("transform", function(d) { return "translate(" + arc.centroid(d) + ")"; })
	  .attr("dy", ".35em")
	  .style("text-anchor", "middle")
	  .text(function(d) { 
		var retVal = shortenValueFilter(d.data.pieCat)
		retVal = replaceAll('_', ' ', retVal)
		return retVal; 
	  });
	  
	/* Initialize legend */
	count = 0;
	var legend = svg.selectAll(".legend")
		.data(data).enter()
		.append("g").attr("class", "legend")
		.attr("legend-id", function(d) { return count++; })
		.attr("transform", function(d, i) {
			  return "translate(-750," + (110 + i * 20) + ")";
		 })
		.on("click", function() {
		  console.log("#arc-" + $(this).attr("legend-id"));
		  var arc = d3.select("#arc-" + $(this).attr("legend-id"));
		  arc.style("opacity", 0.3);
		  setTimeout(function() {
			  arc.style("opacity", 1);
		  }, 1000);
		});	 
 
	//update legend
	legend.append("rect")
      .attr("x", width / 2)
      .attr("width", 18).attr("height", 18)
      .style("fill", function(d) {
          return color(d.pieCat);
      });
    legend.append("text").attr("x", width / 2)
      .attr("y", 9).attr("dy", ".35em")
      .style("text-anchor", "end").text(function(d) {
          var retVal = shortenValueFilter(d.pieCat)
		  retVal = replaceAll('_', ' ', retVal) + ""
		  return retVal;
      });	 
	  

}
</script>
</body>
</html>