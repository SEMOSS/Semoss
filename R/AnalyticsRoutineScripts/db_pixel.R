trim <- function( x ) {
  gsub("(^[[:space:]]+|[[:space:]]+$)", "", x)
}

build_pixel_single_select<-function(select_part2,req_tbls,cur_db){
	pixel_single_select<-data.table(part=character(),item1=character(),item2=character(),item3=character(),item4=character(),item5=character(),item6=character(),item7=character())
	if(length(select_part2)!=0){
		n<-length(select_part2)
		for(i in 1:n){
			clmn<-select_part2[i]
			tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
			if(length(tbls)>0){
				tbl<-tbls[1]
				clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
				pixel_single_select<-rbindlist(list(pixel_single_select,list("select",tbl,clmn,"","","","","")))
			}
		}
	}
	gc()
	return(pixel_single_select)
}

build_pixel_group<-function(group_part,req_tbls,cur_db){
	pixel_single_select<-data.table(part=character(),item1=character(),item2=character(),item3=character(),item4=character(),item5=character(),item6=character(),item7=character())
	if(length(group_part)!=0){
		n<-length(group_part)
		for(i in 1:n){
			clmn<-group_part[i]
			tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
			if(length(tbls)>0){
				tbl<-tbls[1]
				clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
				pixel_single_select<-rbindlist(list(pixel_single_select,list("group",tbl,clmn,"","","","","")))
			}
		}
	}
	gc()
	return(pixel_single_select)
}

build_pixel_aggr_select<-function(select_part1,req_tbls,cur_db){
	pixel_aggr_select<-data.table(part=character(),item1=character(),item2=character(),item3=character(),item4=character(),item5=character(),item6=character(),item7=character())
	if(length(select_part1)!=0){
		n<-length(select_part1)
		for(i in 1:n){
			if(length(unlist(strsplit(select_part1[i],"as")))==2){
				x<-unlist(strsplit(select_part1[i],"as"))
				alias<-trim(x[2])
				pos1<-unlist(gregexpr(pattern="[(]",x[1]))
				pos2<-unlist(gregexpr(pattern="[)]",x[1]))
				aggr<-trim(substr(x[1],1,pos1-1))
				clmn<-trim(substr(x[1],pos1+1,pos2-1))
				tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					pixel_aggr_select<-rbindlist(list(pixel_aggr_select,list("select",tbl,clmn,aggr,alias,"","","")))
				}
			}
		}
	}
	gc()
	return(pixel_aggr_select)
}

build_pixel_having<-function(having_part,req_tbls,cur_db){
	pixel_having<-data.table(part=character(),item1=character(),item2=character(),item3=character(),item4=character(),item5=character(),item6=character(),item7=character())
	if(length(having_part)!=0){
		n<-length(having_part)
		for(i in 1:n){
			if(length(unlist(strsplit(having_part[i],"between")))==2){
				# handle between
				oper<-"between"
				x<-unlist(strsplit(having_part[i],"between"))
				
				pos1<-unlist(gregexpr(pattern="[(]",x[1]))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",x[1]))
					aggr<-trim(substr(x[1],1,pos1-1))
					clmn<-trim(substr(x[1],pos1+1,pos2-1))
				}else{
					aggr<-""
					clmn<-trim(x[1])
				}
				tbls<-cur_db[cur_db$Column == clmn & cur_db$Table %in% req_tbls,"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					if(length(unlist(strsplit(x[2],"and")))==2){
						y<-unlist(strsplit(x[2],"and"))
						value<-trim(y[1])
						value2<-trim(y[2])
						# to do: add aggregates for the right part
						pixel_having<-rbindlist(list(pixel_having,list("having",tbl,clmn,aggr,oper,value,value2,"")))
					}
				}
			}else if(length(unlist(strsplit(having_part[i],">=")))==2){
				oper<-">="
				x<-unlist(strsplit(having_part[i],">="))
				pos1<-unlist(gregexpr(pattern="[(]",x[1]))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",x[1]))
					aggr<-trim(substr(x[1],1,pos1-1))
					clmn<-trim(substr(x[1],pos1+1,pos2-1))
				}else{
					aggr<-""
					clmn<-trim(x[1])
				}
				value<-trim(x[2])
				pos1<-unlist(gregexpr(pattern="[(]",value))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",value))
					aggr2<-trim(substr(value,1,pos1-1))
					clmn2<-trim(substr(value,pos1+1,pos2-1))
					tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn2) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
					if(length(tbls)>0){
						tbl2<-tbls[1]
						clmn2<-cur_db[cur_db$Table==tbl2 & tolower(clmn2) == tolower(cur_db$Column),"Column"]
					}else{
						tbl2<-""
					}
				}else{
					aggr2<-""
					tbl2<-value
					clmn2<-""
				}
				tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					pixel_having<-rbindlist(list(pixel_having,list("having",tbl,clmn,aggr,oper,tbl2,clmn2,aggr2)))
				}				
			}else if(length(unlist(strsplit(having_part[i],"<=")))==2){
				oper<-"<="
				x<-unlist(strsplit(having_part[i],"<="))
				pos1<-unlist(gregexpr(pattern="[(]",x[1]))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",x[1]))
					aggr<-trim(substr(x[1],1,pos1-1))
					clmn<-trim(substr(x[1],pos1+1,pos2-1))
				}else{
					aggr<-""
					clmn<-trim(x[1])
				}
				value<-trim(x[2])
				pos1<-unlist(gregexpr(pattern="[(]",value))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",value))
					aggr2<-trim(substr(value,1,pos1-1))
					clmn2<-trim(substr(value,pos1+1,pos2-1))
					tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn2) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
					if(length(tbls)>0){
						tbl2<-tbls[1]
						clmn2<-cur_db[cur_db$Table==tbl2 & tolower(clmn2) == tolower(cur_db$Column),"Column"]
					}else{
						tbl2<-""
					}
				}else{
					aggr2<-""
					tbl2<-value
					clmn2<-""
				}
				tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					pixel_having<-rbindlist(list(pixel_having,list("having",tbl,clmn,aggr,oper,tbl2,clmn2,aggr2)))
				}	
			}else if(length(unlist(strsplit(having_part[i],">")))==2){
				oper<-">"
				x<-unlist(strsplit(having_part[i],">"))
				pos1<-unlist(gregexpr(pattern="[(]",x[1]))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",x[1]))
					aggr<-trim(substr(x[1],1,pos1-1))
					clmn<-trim(substr(x[1],pos1+1,pos2-1))
				}else{
					aggr<-""
					clmn<-trim(x[1])
				}
				value<-trim(x[2])
				pos1<-unlist(gregexpr(pattern="[(]",value))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",value))
					aggr2<-trim(substr(value,1,pos1-1))
					clmn2<-trim(substr(value,pos1+1,pos2-1))
					tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn2) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
					if(length(tbls)>0){
						tbl2<-tbls[1]
						clmn2<-cur_db[cur_db$Table==tbl2 & tolower(clmn2) == tolower(cur_db$Column),"Column"]
					}else{
						tbl2<-""
					}
				}else{
					aggr2<-""
					tbl2<-value
					clmn2<-""
				}
				tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					pixel_having<-rbindlist(list(pixel_having,list("having",tbl,clmn,aggr,oper,tbl2,clmn2,aggr2)))
				}	
			}else if(length(unlist(strsplit(having_part[i],"<")))==2){
				oper<-"<"
				x<-unlist(strsplit(having_part[i],"<"))
				pos1<-unlist(gregexpr(pattern="[(]",x[1]))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",x[1]))
					aggr<-trim(substr(x[1],1,pos1-1))
					clmn<-trim(substr(x[1],pos1+1,pos2-1))
				}else{
					aggr<-""
					clmn<-trim(x[1])
				}
				value<-trim(x[2])
				pos1<-unlist(gregexpr(pattern="[(]",value))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",value))
					aggr2<-trim(substr(value,1,pos1-1))
					clmn2<-trim(substr(value,pos1+1,pos2-1))
					tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn2) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
					if(length(tbls)>0){
						tbl2<-tbls[1]
						clmn2<-cur_db[cur_db$Table==tbl2 & tolower(clmn2) == tolower(cur_db$Column),"Column"]
					}else{
						tbl2<-""
					}
				}else{
					aggr2<-""
					tbl2<-value
					clmn2<-""
				}
				tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					pixel_having<-rbindlist(list(pixel_having,list("having",tbl,clmn,aggr,oper,tbl2,clmn2,aggr2)))
				}	
			}else if(length(unlist(strsplit(having_part[i],"=")))==2){
				oper<-"="
				x<-unlist(strsplit(having_part[i],"="))
				pos1<-unlist(gregexpr(pattern="[(]",x[1]))
				if(pos1>0){
					pos2<-unlist(gregexpr(pattern="[)]",x[1]))
					aggr<-trim(substr(x[1],1,pos1-1))
					clmn<-trim(substr(x[1],pos1+1,pos2-1))
				}else{
					aggr<-""
					clmn<-trim(x[1])
				}
				value<-trim(x[2])
				pos1<-unlist(gregexpr(pattern="[(]",value))
				if(length(pos1)>0){
					pos2<-unlist(gregexpr(pattern="[)]",value))
					aggr2<-trim(substr(value,1,pos1[1]-1))
					# it is actual value for having
					clmn2<-trim(substr(value,pos1[1]+1,pos2[length(pos2)]-1))
					# here is the actual column to validate
					clmn_val<-trim(substr(value,pos1[length(pos1)]+1,pos2[1]-1))
					tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn_val) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
					if(length(tbls)>0){
						tbl2<-tbls[1]
						clmn2<-cur_db[cur_db$Table==tbl2 & tolower(clmn2) == tolower(cur_db$Column),"Column"]
					}else{
						tbl2<-""
					}
				}else{
					aggr2<-""
					tbl2<-value
					clmn2<-""
				}
				tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					pixel_having<-rbindlist(list(pixel_having,list("having",tbl,clmn,aggr,oper,tbl2,clmn2,aggr2)))
				}	
			}
		}
	}
	gc()
	return(pixel_having)
}

build_pixel_where<-function(where_part,req_tbls,cur_db){
	pixel_where<-data.table(part=character(),item1=character(),item2=character(),item3=character(),item4=character(),item5=character(),item6=character(),item7=character())
	if(length(where_part)!=0){
		n<-length(where_part)
		for(i in 1:n){
			if(length(unlist(strsplit(where_part[i],"between")))==2){
				# handle between
				oper<-"between"
				x<-unlist(strsplit(where_part[i],"between"))
				clmn<-trim(x[1])
				tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
				if(length(tbls)>0){
					tbl<-tbls[1]
					clmn<-cur_db[cur_db$Table==tbl & tolower(clmn) == tolower(cur_db$Column),"Column"]
					if(length(unlist(strsplit(x[2],"and")))==2){
						y<-unlist(strsplit(x[2],"and"))
						value<-trim(y[1])
						value2<-trim(y[2])
						pixel_where<-rbindlist(list(pixel_where,list("where",tbl,clmn,oper,value,value2,"","")))
					}
				}
			}else if(length(unlist(strsplit(where_part[i],">=")))==2){
				# handle >=
				oper<-">="
				x<-unlist(strsplit(where_part[i],">="))
				item1<-trim(x[1])
				item2<-trim(x[2])
				pixel_where<-where_helper(item1,item2,oper,pixel_where,req_tbls,cur_db)
			}else if(length(unlist(strsplit(where_part[i],"<=")))==2){
				# handle <=
				oper<-"<="
				x<-unlist(strsplit(where_part[i],"<="))
				item1<-trim(x[1])
				item2<-trim(x[2])
				pixel_where<-where_helper(item1,item2,oper,pixel_where,req_tbls,cur_db)
			}else if(length(unlist(strsplit(where_part[i],">")))==2){
				# handle >
				oper<-">"
				x<-unlist(strsplit(where_part[i],">"))
				item1<-trim(x[1])
				item2<-trim(x[2])
				pixel_where<-where_helper(item1,item2,oper,pixel_where,req_tbls,cur_db)
			}else if(length(unlist(strsplit(where_part[i],"<")))==2){
				# handle <
				oper<-"<"
				x<-unlist(strsplit(where_part[i],"<"))
				item1<-trim(x[1])
				item2<-trim(x[2])
				pixel_where<-where_helper(item1,item2,oper,pixel_where,req_tbls,cur_db)
			}else if(length(unlist(strsplit(where_part[i],"=")))==2){
				# handle =
				oper<-"="
				x<-unlist(strsplit(where_part[i],"="))
				item1<-trim(x[1])
				item2<-trim(x[2])
				pixel_where<-where_helper(item1,item2,oper,pixel_where,req_tbls,cur_db)
			}else if(length(unlist(strsplit(where_part[i],"\\?like")))==2){
				oper<-"?like"
				x<-unlist(strsplit(where_part[i],"\\?like"))
				item1<-trim(x[1])
				item2<-trim(x[2])
				pixel_where<-where_helper(item1,item2,oper,pixel_where,req_tbls,cur_db)
			}
		}
	}
	gc()
	return(pixel_where)
}

where_helper<-function(item1,item2,oper,pixel_where,req_tbls,cur_db){
	p1<-parse_aggr(cur_db,req_tbls,item1)
	# if there are 3 element it is an aggregate otherwise it can be either value or column
	if(length(p1) == 3){
		item1=p1[2]
	}
	p2<-parse_aggr(cur_db,req_tbls,item2)
	if(length(p2)==3){
		item2=p2[2]
	}
	# check if item1 is column
	tbls1<-cur_db[tolower(cur_db$Column) == tolower(item1) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
	#check if item2 is column
	tbls2<-cur_db[tolower(cur_db$Column) == tolower(item2) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
	#construct where
	if(length(tbls1)>0 & length(tbls2)>0){
		if(length(p1)==3 & length(p2)==3){
			# both aggregate columns
			pixel_where<-rbindlist(list(pixel_where,list("where",p1[1],p1[2],p1[3],oper,p2[1],p2[2],p2[3])))
		}else if(length(p1)==3 & length(p2)!=3){
			# first is aggregate column, second regular column
			item2<-cur_db[cur_db$Table==tbls2[1] & tolower(item2) == tolower(cur_db$Column),"Column"]
			pixel_where<-rbindlist(list(pixel_where,list("where",p1[1],p1[2],p1[3],oper,tbls2[1],item2,"")))
		}else if(length(p1)!=3 & length(p2)==3){
			# # first is regular column, second aggregate column
			item1<-cur_db[cur_db$Table==tbls1[1] & tolower(item2) == tolower(cur_db$Column),"Column"]
			pixel_where<-rbindlist(list(pixel_where,list("where",tbls1[1],item1,oper,p2[1],p2[2],p2[3],"")))
		}else{
			# both regular columns
			item1<-cur_db[cur_db$Table==tbls1[1] & tolower(item1) == tolower(cur_db$Column),"Column"]
			item2<-cur_db[cur_db$Table==tbls2[1] & tolower(item2) == tolower(cur_db$Column),"Column"]
			pixel_where<-rbindlist(list(pixel_where,list("where",tbls1[1],item1,oper,tbls2[1],item2,"","")))
		}	
	}else if(length(tbls1)>0 & length(tbls2)==0){
		# first is a column, second is a value
		p1<-parse_aggr(cur_db,req_tbls,item1)	
		if(length(p1)==3){
			# first is an aggregate column
			pixel_where<-rbindlist(list(pixel_where,list("where",p1[1],p1[2],p1[3],oper,item2,"","")))
		}else{
			# first is a regular column
			item1<-cur_db[cur_db$Table==tbls1[1] & tolower(item1) == tolower(cur_db$Column),"Column"]
			pixel_where<-rbindlist(list(pixel_where,list("where",tbls1[1],item1,oper,item2,"","","")))
		}
	}else if(length(tbls1)==0 & length(tbls2)>0){
		# first is a value, second is a column
		p2<-parse_aggr(cur_db,req_tbls,item2)
		if(length(p2)==3){
			# second is an aggregate value
			pixel_where<-rbindlist(list(pixel_where,list("where",item1,oper,p2[1],p2[2],p2[3],"","")))
		}else{
			# second is a regular column
			item2<-cur_db[cur_db$Table==tbls2[1] & tolower(item2) == tolower(cur_db$Column),"Column"]
			pixel_where<-rbindlist(list(pixel_where,list("where",item1,oper,tbls2[1],item2,"","","")))
		}
	}else if(length(tbls1)==0 & length(tbls2)==0){
		pixel_where<-rbindlist(list(pixel_where,list("where",item1,oper,item2,"","","","")))
	}
	return(pixel_where)
}

parse_aggr<-function(cur_db,req_tbls,item){
	parsed_value<-vector()
	pos1<-unlist(gregexpr(pattern="[(]",item))
	if(pos1>0){
		pos2<-unlist(gregexpr(pattern="[)]",item))
		aggr<-trim(substr(item,1,pos1-1))
		clmn<-trim(substr(item,pos1+1,pos2-1))
		# Validate table
		tbls<-cur_db[tolower(cur_db$Column) == tolower(clmn) & tolower(cur_db$Table) %in% tolower(req_tbls),"Table"]
		if(length(tbls)>0){
			tbl<-tbls[1]
			clmn<-cur_db[cur_db$Table==tbls & tolower(clmn) == tolower(cur_db$Column),"Column"]
			parsed_value<-c(tbl,clmn,aggr)
		}
	}else{
		parsed_value<-item
	}
	return(parsed_value)
}

build_pixel_from<-function(from_joins){
	from_pixel<-data.table(part=character(),item1=character(),item2=character(),item3=character(),item4=character(),item5=character(),item6=character(),item7=character())
	if(nrow(from_joins)>0){
		from_joins$joinby1<-as.character(from_joins$joinby1)
		from_joins$joinby2<-as.character(from_joins$joinby2)
		n<-nrow(from_joins)
		for(i in 1:n){
			from_pixel<-rbindlist(list(from_pixel,list("from",from_joins$tbl1[i],from_joins$joinby1[i],from_joins$tbl2[i],from_joins$joinby2[i],"","","")))
		}
	}
	gc()
	return(from_pixel)
}

build_pixel<-function(appid,pixel_aggr_select,pixel_single_select,pixel_where,pixel_group,pixel_having,pixel_from){
	pixel<-data.table(part=character(),item1=character(),item2=character(),item3=character(),item4=character(),item5=character(),item6=character(),item7=character())
	if(nrow(pixel_single_select)>0){
		pixel<-rbind(pixel,pixel_single_select)
	}
	if(nrow(pixel_aggr_select)>0){
		pixel<-rbind(pixel,pixel_aggr_select)
	}
	if(nrow(pixel_from)>0){
		pixel<-rbind(pixel,pixel_from)
	}
	if(nrow(pixel_where)>0){
		pixel<-rbind(pixel,pixel_where)
	}
	if(nrow(pixel_group)>0){
		pixel<-rbind(pixel,pixel_group)
		if(nrow(pixel_having)>0){
			pixel<-rbind(pixel,pixel_having)
		}
	}
	pixel<-normalize_pixel(appid,pixel)
	gc()
	return(pixel)
}

normalize_pixel<-function(appid,pixel){
	N<-nrow(pixel)
	M<-ncol(pixel)
	if(N>0 & M>0){
		pixel$label<-""
		pixel$appid<-""
		pixel$appid2<-""
		pixel<-pixel[,c(9,10,11,1,2,3,4,5,6,7,8)]
		for(i in 1:N){
			rec<-as.character(pixel[i,])
			k<-0
			for(j in 4:(M+3)){
				if(rec[j]!="") {
					items<-unlist(strsplit(rec[j],"._.",fixed=TRUE))
					if(length(items)==2){
						pixel[i,2+k]<-items[1]
						pixel[i,j]<-items[2]
						if(k==1) {
							break
						}else{
							k<-k+1
						}
					}
				}else{
					break
				}
			}
		}
		pixel$label<-appid
	}
	gc()
	return(pixel)
}
